# 阿里云 ESA 配置详细指南

## 一、准备工作

### 1. 登录阿里云控制台
- 访问：https://esa.console.aliyun.com/
- 使用阿里云账号登录

### 2. 开通 ESA 服务
- 如果未开通，需要先开通 **边缘安全加速（ESA）** 服务
- 确保账户有足够的余额或已开通按量付费

---

## 二、创建边缘函数

### 步骤 1：进入函数管理页面
1. 登录 ESA 控制台后，点击左侧菜单 **边缘计算** → **边缘函数**
2. 点击 **创建函数** 按钮

### 步骤 2：填写函数基本信息
- **函数名称**：`export`（或自定义名称）
- **运行时环境**：选择 `Node.js 18` 或 `Node.js 20`（根据支持的版本）
- **函数描述**：`导出 MongoDB 数据`

### 步骤 3：上传函数代码

**方式一：在线编辑**
1. 选择 **在线编辑** 方式
2. 将 `aliyun-esa/export.js` 文件内容复制粘贴到编辑器中
3. 确保代码格式正确

**方式二：上传 ZIP 包**
1. 在 `aliyun-esa` 目录下创建 ZIP 包：
```bash
cd aliyun-esa
zip -r function.zip export.js package.json
```
2. 在控制台选择 **上传 ZIP 包**
3. 上传 `function.zip` 文件

**方式三：从 GitHub 导入**（推荐）
1. 将代码推送到 GitHub 仓库
2. 在控制台选择 **从代码仓库导入**
3. 连接 GitHub 账号
4. 选择仓库和分支
5. 指定代码路径为 `aliyun-esa/`

### 步骤 4：配置函数入口
- **入口函数**：`handler`（对应代码中的 `export default async function handler`）
- **超时时间**：建议设置为 `30秒` 或更长
- **内存规格**：建议 `128MB` 或 `256MB`

---

## 三、配置环境变量

### 步骤 1：进入环境变量配置
在函数详情页面，找到 **环境变量** 或 **配置** 选项卡

### 步骤 2：添加环境变量
点击 **添加环境变量**，配置以下变量：

| 变量名 | 变量值 | 说明 |
|--------|--------|------|
| `MONGODB_URI` | `mongodb://atlaseuan:ysygfy980@xwx.xiaokong.space:21017/admin` | MongoDB 连接字符串（建议使用环境变量而不是硬编码） |

**注意**：敏感信息建议使用环境变量，不要硬编码在代码中。

---

## 四、配置触发器（路由）

### 步骤 1：创建触发器
在函数详情页面，找到 **触发器** 或 **路由** 选项卡

### 步骤 2：配置 HTTP 触发器
- **触发方式**：选择 **HTTP 触发器**
- **请求路径**：`/export`（或自定义路径）
- **请求方法**：选择 `GET`
- **认证方式**：根据需求选择（如无需认证，选择"无认证"）

### 步骤 3：绑定域名（可选）
如果需要绑定自定义域名：
1. 在 ESA 控制台创建站点
2. 配置域名解析（NS 或 CNAME）
3. 在函数触发器配置中绑定域名

---

## 五、部署和测试

### 步骤 1：部署函数
1. 完成配置后，点击 **部署** 或 **发布** 按钮
2. 等待部署完成（通常几秒钟）

### 步骤 2：获取函数访问地址
部署成功后，会生成函数访问地址，格式类似：
```
https://your-function-id.esa.aliyuncs.com/export
```

### 步骤 3：测试函数
使用 curl 或浏览器测试：
```bash
# 测试 GET 请求
curl https://your-function-id.esa.aliyuncs.com/export

# 或使用浏览器直接访问
```

### 步骤 4：查看日志
- 在函数详情页面，点击 **日志** 选项卡
- 查看函数执行日志，排查问题

---

## 六、常见问题排查

### 1. 函数执行超时
- **原因**：数据库连接或查询时间过长
- **解决**：增加超时时间设置，或优化数据库查询

### 2. 模块导入错误
- **原因**：ES6 模块语法不支持
- **解决**：确保运行时环境支持 ES6，或检查代码格式

### 3. MongoDB 连接失败
- **原因**：网络不通或连接字符串错误
- **解决**：
  - 检查 MongoDB 是否允许从边缘节点访问
  - 验证连接字符串是否正确
  - 检查防火墙设置

### 4. 依赖包缺失
- **原因**：`mongodb` 包未正确打包
- **解决**：
  - 确保 `package.json` 包含依赖
  - 使用 ZIP 包上传时包含 `node_modules`（如果支持）
  - 或使用 Serverless Devs 自动打包

---

## 七、使用 Serverless Devs 部署（可选）

### 1. 安装工具
```bash
npm install -g @serverless-devs/s
```

### 2. 配置凭证
```bash
s config add
```
按提示输入：
- Alias: `default`（或自定义）
- AccountID: 你的阿里云账号 ID
- AccessKeyID: 你的 AccessKey ID
- AccessKeySecret: 你的 AccessKey Secret

### 3. 创建配置文件
```bash
cp s.yaml.example s.yaml
```
编辑 `s.yaml`，填入实际配置

### 4. 部署
```bash
s deploy
```

---

## 八、监控和维护

### 1. 查看监控数据
- 在函数详情页面查看：
  - 调用次数
  - 错误率
  - 平均响应时间
  - 流量统计

### 2. 设置告警
- 配置告警规则，监控函数异常
- 设置错误率阈值告警

### 3. 版本管理
- ESA 支持函数版本管理
- 可以回滚到之前的版本

---

## 九、安全建议

1. **环境变量**：将敏感信息（如数据库密码）配置为环境变量
2. **访问控制**：配置函数访问权限，限制调用来源
3. **密钥验证**：启用代码中的密钥验证逻辑
4. **HTTPS**：使用 HTTPS 访问函数
5. **日志脱敏**：避免在日志中输出敏感信息

---

## 十、参考链接

- [阿里云 ESA 官方文档](https://help.aliyun.com/zh/edge-security-acceleration/esa/)
- [边缘函数开发指南](https://help.aliyun.com/zh/edge-security-acceleration/esa/user-guide/what-is-functions-and-pages/)
- [Serverless Devs 文档](https://www.serverless-devs.com/)

